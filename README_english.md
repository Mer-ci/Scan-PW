#SCAN PW

(see wiki)

Scan pw in order to centralize all your passwords on your mobile, it helps to not have remember all your passwords used every days (credit card, websites, mail box ...). The advantage of scan pw is to use innovative technology to quickly find your passwords automatically and fill out the fields in logins on all your sites. Scan pw is composed of three parts: a mobile application (android), a Chrome extension, and a server.

	I mobile Application

The mobile application is the heart of scan pw, it will stored all your passwords and allow you to find them easily, all protect by a master password.

	II chrome extension	

The Chrome extension detect when a web page need fill out a login, when it detect this it generate a QR Code. The mobile will scan and send to extension the corresponding identifiers, when extension receive identifiers it fill out the desired fields.

		II.1 menus extension

These options are:
- The display of the QR code with resizing, can disable the automatic display of the popup, a help button.

![extension menu](/img/menuExtension.png "extension menu")


		II.2 Recognition of the need identifiers and generate QRCode


The extension goes through each page and check whether it requires identifiers, if it detect field it generate a QRCode. The detection part is in the content script to access the web page visited. The automatic detection can be disabled, if it is off you can still display the QR code through popup extension. Note that if the fields are not automatically detected IDs can be inserted through a context menu. The QRCode can be resized to facilitate scan QRCode, it contains: the URL of the page and the public key.

		II.3 inner workings


The extension is separate into several files based on features of the chrome extension. The various files and their features are:
- Popup.js: this JavaScript file linked to a "popup.html" page, but the view is generated by qrview.js. This pop-up will display the QR code if it does not appear automatically.
- Qrview.js: Manage the main display of the extension and the user interaction on the access to help and setting, several options such as the choice of the size of the QR code, activate / disable auto display QR.
- Background.js: JavaScript file linked to a "background.html" page for reporting external files. This file will allow communication between the different modules of the extension and it will also do background tasks like making server calls. It is composed of listener, and the implementation of functions to create menus.
- Content.js js file that will be executed within the load in the browser. This file will serve to detect fields login, logins and insert in these fields. If automatic detection is enabled, it will also display the main view (generated by qrview.js) directly into the webpage visited
- Communication.js: JavaScript file that will aim to communicate with the server.
- Crypto.js: JavaScript file that will handle the cryptography generation public / private key encryption / decryption of data.
- QRcode.js: JavaScript file that will be generating the QR Code.

![extension operations](/img/extensionOperations.png "extension operations")


	III server


The server is an intermediary between the extension and the mobile, because they do not directly communicate with each other (direct communication may be implemented later). The server is made Node.js and uses a postgres data base.

		III.1 Server Operation

The serveur.js can be launched directly through the command line node, ex: node serveur.js, or by specifying the port in older (8080 by default) Example: node serveur.js 8081.

But we have created scripts to simply start the server and launch a number of check. These scripts are stored in / var / scanPwd.web / scripts, we have three scripts (see section using scripts).

We put the logs in / var / scanPwd.web / bin / log (log files may change depending on the tools used)

		III.2 Using scripts

We have three scripts stored in / var / scanPwd.web / scripts that are:
- Start.sh which launches the server node and postgres. It may have two options, the first option can be: start (launch of the classic routine) Snode (start node only) sPostgres (only launches postgres). The second argument is used to specify a port example: start.sh start 8090, will launch the server on port 8090.
- Stop.sh will help to stop a server specified. It may be an option that is: stop using the default will be a classic case of the server, Nstop will only stop node, and will only stop pSTOP postgres.
- Check.sh used by start.sh to the check can be issued only to allow viewing of the server status. It has two options, the first to choose the mode: check to launch a comprehensive check, pCheck launches only a check on ncheck and postgres that can launch a check on node. The second argument is used as in start.sh to specify a port.


		III.3 special users


There are three special users:
- P1ext: will allow to manage the server, he can run scripts to start, stop, etc.. Only individuals in the group p1ext can connect with:
sudo-u-i p1ext

- postgres : to administer Postgres, you can connect with that through the "su" user. example:
sudo su
su postgres
psql

- Scanpwd_postgres : user postgres that will be used by the server for all transactions needed based on 4dory data. This user will only have rights UPDATE, SELECT, DELETE and insert into the templogins table.


		III.4 server install


Begin by instal node.js
	
sudo apt-get install python g++ make checkinstall
mkdir ~/src && cd $_
wget –N http://nodejs.org/dist/node-latest.tar.gz
tar xzvf node-latest.tar.gz && cd node-v*
./configure
sudo make install
		server and install all necessary modules (file location : /opt/scanPwd.web/bin)
Copy file « serveur.js » and instal : crypto, forever (global instal : sudo npm install forever –g), node-bignumber, pg, querystring, request, url, winston.

Do not forget the log file : touch /opt/scanPwd.web/bin/log/Logging.log 

Création de l’utilisateur p1ext qui sera utilisé pour lancer le serveur, on pourra se connecter à lui qu’en passant par l’utilisateur su.
Create the p1ext user, he will used for lunch server, we can connect to him only with the root user.

sudo useradd p1ext
sudo passwd p1ext
if shell problem look in /etc/passwd for user's if sh remplaced by bash

sudo usermod –a –G p1ext {user to add}

sudo su
visudo
add : %p1ext ALL = (p1ext) NOPASSWD: ALL
exit

sudo nano .bashrc
add :alias sup1ext="sudo -u p1ext -i"

Placing script files (location : /opt/scanPwd.web/scripts ) 

copy files start.sh, stop.sh, check.sh, permissions.sh
		
Then install Postgres SQL

sudo apt-get install postgresql
sudo passwd postgres (to allow to connect as postgres)
Create table
su postgres
createdb 4dory
You can use pgadmin3
		change /etc/posctgresql/8.4/main/postgresql.conf -> listen_addresses = 'localhost, 10.11.1.104'
		change /etc/posctgresql/8.4/main/pg_hba.conf add :
			host all all 10.10.0.0/24 trust
host all all {server ip}/{net mask} ident
host all all 10.10.0.101/24 trust
modifier :
local   all         all                               trust
host    all         all         127.0.0.1/32          trust
host    all         all         ::1/128               md5

Add templogins table using the following script (which will also create the user scanpwd_postgres)
-- Table: templogins  -- DROP TABLE templogins;  CREATE TABLE templogins (   dateajout date,   datecommobile date,   alea character varying(350),   clepub character varying(350),   usr character varying(512),   mdp character varying(512),   url character varying(255),   nbessai integer,   cancel boolean DEFAULT false,   id serial NOT NULL,   "isLogin" boolean DEFAULT false,   CONSTRAINT id PRIMARY KEY (id) ) WITH (   OIDS=FALSE ); ALTER TABLE templogins   OWNER TO postgres; GRANT ALL ON TABLE templogins TO postgres; CREATE USER scanpwd_postgres WITH PASSWORD 'sCanPw2-P'; GRANT SELECT, UPDATE, INSERT, DELETE ON TABLE templogins TO scanpwd_postgres;  GRANT USAGE, SELECT ON SEQUENCE public.templogins_id_seq TO scanpwd_postgres;
 

Give right connection postgres and make the user postgres impossible to connect without using the root user.
To do this edit / ect / postgres / {version} / main / pg_hba.conf
Comment all lines except:
host all scanpwd_postgres 10.10.0.0/24 trust
local   all         all                               ident
host    all         all         127.0.0.1/32          trust

All connections on the 10.0.0.0 network will be accepted for scanpwd_postgres in trust, only the server can connect to postgres on ident.

passwd –l postgres (prevents the connection with password and requires the connection postgres from the root)
reversible with passwd –u postgres

Start the server using the start script (see Using scripts)
	
	IV Communications


		IV.1 PC - mobile


the mobile communicate with PC by QR Code (for more detail see frame part)

-	public key
-	URL


		IV.2 Mobile - serveur


The communication between mobile and server is made by a HTTP connection on HTTP. The mobile send this information on JSON format :

-	public key
-	logins and URL crypted by the extension public key

Mobile can stop transaction on sending a cancel frame.

		IV.3 PC - serveur

Communication will be using HTTP and the data was send on JSON.

When a QR Code was generate, the extension send a request to the server with a public key -> when the server get request we checked if the public key match then the server send crypted alea with extension public key -> the extension decrypts alea and send it to server -> server check if alea is same and he send login data *.

* At this time we wait that mobile send login's data

		IV.4 action's codes

Communication's code with server :
-	Action = mdp : extension ask login.
o	Positive response: code 200 -> crypt alea (JSON)
o	négative response : Erreur 520 (see error's code)
-	Action = sAlea : extension send crypt alea.
o	positive response : code 200 -> send logins + URL
o	négative response: code 520, 521, 522, 523 (see error's code)
-	Action = r : mobile send logins
o	positive response : code 200 -> « success »
o	négative response : Erreur 520 (see error's code)
-	Action = c : cancel control
o	positive response : code 200 -> « success »
o	négative response : Erreur 520 (see error's code)


		IV.5 error's code


error's code generate by server :
-	Erreur 520 : problem with data base -> send error generate by postgres module.
-	Erreur 521 : ask new request -> send « waitLogin »
-	Erreur 522 : waiting time login is too long -> send « cancel »
-	Erreur 523 : identifier received a cancel request.


	V Frames

	
		V.1 Between extension and mobile


The information send by QR Code, we choose a frame look like a URL, to remain consistent with the QR Code technology, it containing the URL truncated, a public key on 1024 bits and a action's code to be r. Example :

http://r.mer.ci?r&CCCFvggbzzscvrted542c45fv56CCCFvggbzzscvrted542c45fv56CCCFvggbzzscvrted542c45fv56CCCFvggbzzscvrted542c45fv56CCCFvggbzzscvrted542c45fv56CCCFvggbzzscvrted542c45fv56CCCFvggbzzscvrted542c45fv56CCCFvggbzzscvrted542c45fv5&www.amazon.fr


		V.2 between extension and server


The informations send on JSON, the frame's format is :

-	send public key
{
	public key : « cle »
}

-	reception crypted alea
{
	alea : « alea »
}
-	send decrypt alea
{
	alea : « alea »
}

-	reception data
{
	URL : «  www.monUrl.com « ,
	userLogin : « user » ,
	userMdp : « mdp »
}


		V.3 Between extension and mobile


The informations send on JSON, the frame's format is :

-	send logins
{
	type : ‘r’,
	key : ‘the key’,
	URL : ‘www.mon-url.com’,
	login : ‘mon login’,
	pwd : ‘mon pwd’
}
-	send cancel control
{
	type : ‘c’,
	key : ‘my key’
}



	VI possible improvements


- using web sockets for communication
- uuse of encryption elliptic curves that will have the main advantage of reducing the size of the QR code and ease the scan from the mobile.
- create a live connection between the mobile and the extension to avoid having to use a server
- improve the interface of the extension

